<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIA - Nouveau R1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
         /* Feedback message style */
         #feedbackMessage { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); padding: 0.75rem 1.25rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); color: white; font-weight: 600; font-size: 0.875rem; z-index: 50; transition: opacity 300ms ease-in-out; opacity: 0; pointer-events: none; }
         #feedbackMessage.show { opacity: 1; pointer-events: auto; }
         /* Style pour date picker */
         input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
            cursor: pointer;
         }
         /* --- Définition CSS Standard pour .input-style --- */
         .input-style {
            width: 100%;
            background-color: #f1f5f9; /* slate-100 */
            border: 1px solid #94a3b8; /* slate-400 */
            border-radius: 0.5rem; /* rounded-lg */
            padding-top: 0.625rem; /* py-2.5 */
            padding-bottom: 0.625rem;
            padding-left: 1rem; /* px-4 */
            padding-right: 1rem;
            color: #111827; /* gray-900 */
            placeholder-color: #6b7280; /* placeholder-gray-500 */
            outline: none;
         }
         .input-style:focus {
             border-color: #2dd4bf; /* focus:border-teal-400 */
             box-shadow: 0 0 0 2px #5eead4; /* Equivalent focus:ring-2 focus:ring-teal-400 */
         }
        /* Style pour placeholder (méthode standard) */
        .input-style::placeholder {
             color: #6b7280; /* placeholder-gray-500 */
        }
        /* Style pour bouton désactivé */
        .button-disabled {
             width: 100%;
             font-size: 1.125rem; /* text-lg */
             font-weight: 700; /* font-bold */
             padding-top: 0.75rem; /* py-3 */
             padding-bottom: 0.75rem;
             padding-left: 1.25rem; /* px-5 */
             padding-right: 1.25rem;
             border-radius: 0.5rem; /* rounded-lg */
             transition-property: all; /* transition-all */
             transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); /* duration-300 */
             transition-duration: 300ms;
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
             background-color: #4b5563; /* bg-gray-600 */
             color: #9ca3af; /* text-gray-400 */
             cursor: not-allowed;
         }
    </style>
</head>
<body class="bg-gradient-to-b from-gray-900 to-slate-900 text-white h-full flex items-center justify-center">

    <div class="w-full max-w-lg mx-auto p-4">
        <h1 class="text-3xl md:text-4xl font-bold text-teal-300 mb-8 text-center">Planifier un R1</h1>
        <div class="bg-slate-800/70 backdrop-blur-sm border border-slate-700/50 p-6 md:p-8 rounded-xl shadow-2xl space-y-5">

            <a href="dashboard.html" class="block w-full text-center text-sm font-medium py-2 px-4 rounded-lg transition-all duration-300 bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg mb-6">&larr; Voir le Tableau de Bord</a>
            <hr class="border-slate-700 mb-6"/>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div><label for="prospectFirstNameInput" class="block text-sm font-medium text-gray-300 mb-2">Prénom Prospect</label><input id="prospectFirstNameInput" type="text" placeholder="Jean" class="input-style"></div>
                <div><label for="prospectLastNameInput" class="block text-sm font-medium text-gray-300 mb-2">Nom Prospect</label><input id="prospectLastNameInput" type="text" placeholder="Dupont" class="input-style"></div>
            </div>
            <div><label for="prospectDateInput" class="block text-sm font-medium text-gray-300 mb-2">Date R1 Prévue</label><input id="prospectDateInput" type="date" class="input-style"></div>
            <hr class="border-slate-700"/>
            <button id="scheduleButton" disabled class="button-disabled">Remplir Prénom, Nom et Date</button>
        </div>
    </div>
     <!-- Feedback Element -->
     <div id="feedbackMessage"></div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db, auth, appId;
        let isSaving = false;

        async function initFirebase() { /* ... comme avant ... */ try { const firebaseConfig = { apiKey: "AIzaSyCpRtHQd8oybG-uZKBRz-a2uKQCHrXMapY", authDomain: "closing-gia.firebaseapp.com", projectId: "closing-gia", storageBucket: "closing-gia.firebasestorage.app", messagingSenderId: "260776101981", appId: "1:260776101981:web:30d795f1d04a44d19f65b4" }; appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); await new Promise((resolve) => { onAuthStateChanged(auth, async (user) => { if (user) { resolve(); } else { try { await signInAnonymously(auth); resolve(); } catch (e) { console.error("Err anon:", e); resolve(); } } }); }); console.log("Firebase prêt (index.html)"); return true; } catch (error) { console.error("Err init Firebase:", error); showFeedback("Erreur critique: Connexion DB impossible.", true); return false; } }

        document.addEventListener('DOMContentLoaded', async () => {
            const firstNameInput = document.getElementById('prospectFirstNameInput');
            const lastNameInput = document.getElementById('prospectLastNameInput');
            const dateInput = document.getElementById('prospectDateInput');
            const scheduleButton = document.getElementById('scheduleButton');

             const firebaseReady = await initFirebase();
             if (!firebaseReady) { scheduleButton.textContent = "Erreur DB - Recharger"; return; }

            function updateScheduleButtonState() {
                const firstName = firstNameInput.value.trim();
                const lastName = lastNameInput.value.trim();
                const date = dateInput.value;
                const canSchedule = firstName && lastName && date && !isSaving;

                scheduleButton.disabled = !canSchedule;
                if (isSaving) { scheduleButton.textContent = "Enregistrement..."; }
                else if (canSchedule) {
                     scheduleButton.textContent = "Enregistrer et Voir Dashboard";
                     // Appliquer les classes Tailwind pour le bouton activé
                     scheduleButton.className = 'w-full text-lg font-bold py-3 px-5 rounded-lg transition-all duration-300 shadow-lg bg-teal-600 hover:bg-teal-500 text-white shadow-teal-800/40 cursor-pointer';
                } else {
                     scheduleButton.textContent = "Remplir Prénom, Nom et Date";
                     // Utiliser la classe CSS définie pour le bouton désactivé
                     scheduleButton.className = 'button-disabled';
                }
            }

            const today = new Date().toISOString().split('T')[0]; dateInput.value = today;
            firstNameInput.addEventListener('input', updateScheduleButtonState);
            lastNameInput.addEventListener('input', updateScheduleButtonState);
            dateInput.addEventListener('input', updateScheduleButtonState);

            scheduleButton.addEventListener('click', async () => {
                if (isSaving || !db) return; isSaving = true; updateScheduleButtonState();
                const firstName = firstNameInput.value.trim(); const lastName = lastNameInput.value.trim(); const date = dateInput.value; const prospectName = `${firstName} ${lastName}`;
                try {
                     const collectionPath = `artifacts/${appId}/public/data/r1_closings`;
                     const q = query(collection(db, collectionPath), where("prospectName", "==", prospectName), where("prospectDate", "==", date)); const existingDocs = await getDocs(q);
                     if (!existingDocs.empty) { showFeedback(`R1 déjà planifié pour ${prospectName} le ${date}.`, false); }
                     else { const newR1Data = { prospectFirstName: firstName, prospectLastName: lastName, prospectName: prospectName, prospectDate: date, context: {}, customNotes: '', scores: {total: 0}, qualificationStatus: 'N/A', qualificationText: '', savedAt: Timestamp.now(), lastUpdatedAt: Timestamp.now(), closerId: auth?.currentUser?.uid || 'anonymous_user', status: 'R1 Scheduled', amountCollected: 0, recurringAmount: 0, paymentType: null, startDateOfPayment: null, installmentAmount: 0, numberOfInstallments: 0, lostReason: "" }; await addDoc(collection(db, collectionPath), newR1Data); showFeedback("R1 Planifié enregistré.", false); }
                     setTimeout(() => { window.location.href = 'dashboard.html'; }, 1000);
                } catch (error) { console.error("Erreur enregistrement R1:", error); showFeedback("Erreur lors de l'enregistrement !", true); isSaving = false; updateScheduleButtonState(); }
            });
            updateScheduleButtonState(); // Appel initial
        });

         function showFeedback(message, isError = false) { let feedbackEl = document.getElementById('feedbackMessage'); if (!feedbackEl) return; feedbackEl.textContent = message; feedbackEl.classList.remove('bg-red-600', 'bg-green-600', 'opacity-0'); feedbackEl.classList.add(isError ? 'bg-red-600' : 'bg-green-600', 'show'); setTimeout(() => { feedbackEl.classList.remove('show'); feedbackEl.classList.add('opacity-0'); }, 3000); }

         // Plus besoin d'injecter de style ici
    </script>

</body>
</html>

